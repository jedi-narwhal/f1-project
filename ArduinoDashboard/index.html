<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TELEMETRY — LIVE</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:ital,wght@0,300;0,400;0,500;1,300&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
:root {
  --bg:         #0d0f12;
  --surface:    rgba(13,15,18,0.82);
  --surface2:   rgba(255,255,255,0.055);
  --surface3:   rgba(255,255,255,0.035);
  --border:     rgba(255,255,255,0.09);
  --border2:    rgba(255,255,255,0.16);
  --text:       #f0f2f5;
  --text-dim:   rgba(240,242,245,0.45);
  --text-xs:    rgba(240,242,245,0.22);
  --red:        #e8002d;
  --red-dim:    rgba(232,0,45,0.25);
  --green:      #00d67a;
  --green-dim:  rgba(0,214,122,0.25);
  --amber:      #f5a623;
  --amber-dim:  rgba(245,166,35,0.25);
  --blue:       #4facfe;
  --blue-dim:   rgba(79,172,254,0.2);
  --fn:         'DM Mono', monospace;
  --fu:         'Syne', sans-serif;
  --blur:       blur(24px) saturate(1.7);
  --panel-w:    360px;
  --panel-anim: cubic-bezier(0.16, 1, 0.3, 1);
}

*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }

html, body {
  width:100%; height:100%;
  background: var(--bg);
  color: var(--text);
  font-family: var(--fu);
  overflow: hidden;
}

/* ═══════════════════════════════════════
   SIMULATED MAP BACKGROUND
═══════════════════════════════════════ */
#mapCanvas {
  position: fixed;
  inset: 0;
  width: 100%;
  height: 100%;
  z-index: 0;
  transition: width .45s var(--panel-anim);
}
body.panel-open #mapCanvas {
  width: calc(100% - var(--panel-w));
}

/* ═══════════════════════════════════════
   TOP BAR
═══════════════════════════════════════ */
.topbar {
  position: fixed;
  top: 0; left: 0; right: 0;
  height: 56px;
  z-index: 20;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 24px;
  background: linear-gradient(to bottom, rgba(13,15,18,0.92) 0%, transparent 100%);
  transition: right .45s var(--panel-anim);
}
body.panel-open .topbar {
  right: var(--panel-w);
}

.brand {
  font-family: var(--fu);
  font-weight: 800;
  font-size: 20px;
  letter-spacing: 7px;
  color: var(--text);
}
.brand span { color: var(--red); }

.topbar-right {
  display: flex;
  align-items: center;
  gap: 12px;
}

#clock {
  font-family: var(--fn);
  font-size: 11px;
  letter-spacing: 2px;
  color: var(--text-dim);
}

.pill {
  font-family: var(--fn);
  font-size: 8.5px;
  letter-spacing: 1.5px;
  padding: 5px 12px;
  border-radius: 20px;
  border: 1px solid;
  display: flex;
  align-items: center;
  gap: 6px;
  backdrop-filter: blur(10px);
  white-space: nowrap;
}
.pill--g { color: var(--green); border-color: rgba(0,214,122,0.3); background: rgba(0,214,122,0.08); }
.pill--r { color: var(--red); border-color: rgba(232,0,45,0.35); background: rgba(232,0,45,0.1); animation: pillflash .8s ease-in-out infinite; }
.pill--d { color: var(--text-dim); border-color: var(--border); background: rgba(255,255,255,0.04); }

@keyframes pillflash { 0%,100%{opacity:1} 50%{opacity:0.55} }

.dot { width:5px; height:5px; border-radius:50%; flex-shrink:0; }
.dot--g { background:var(--green); box-shadow:0 0 6px var(--green); animation:blink 1.5s ease-in-out infinite; }
.dot--r { background:var(--red); box-shadow:0 0 6px var(--red); animation:blink .6s ease-in-out infinite; }
.dot--a { background:var(--amber); box-shadow:0 0 4px var(--amber); }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.08} }

/* ═══════════════════════════════════════
   BOTTOM HUD
═══════════════════════════════════════ */
.bottom-hud {
  position: fixed;
  bottom: 0; left: 0; right: 0;
  z-index: 20;
  display: flex;
  flex-direction: column;
  align-items: center;
  pointer-events: none;
  transition: right .45s var(--panel-anim);
}
body.panel-open .bottom-hud {
  right: var(--panel-w);
}

/* Speed / RPM / Distance cluster */
.hud-cluster {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0;
  background: var(--surface);
  backdrop-filter: var(--blur);
  -webkit-backdrop-filter: var(--blur);
  border: 1px solid var(--border2);
  border-bottom: none;
  border-radius: 24px 24px 0 0;
  padding: 20px 48px 24px;
  pointer-events: all;
  position: relative;
  overflow: hidden;
  min-width: 600px;
}
.hud-cluster::before {
  content:'';
  position:absolute; top:0; left:0; right:0; height:1px;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.22), transparent);
}

.hud-stat {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 0 32px;
  position: relative;
}
.hud-stat + .hud-stat::before {
  content:'';
  position:absolute; left:0; top:10%; height:80%;
  width:1px; background: var(--border2);
}

.hud-label {
  font-family: var(--fn);
  font-size: 8.5px;
  letter-spacing: 3px;
  color: var(--text-dim);
  margin-bottom: 4px;
  text-transform: uppercase;
}
.hud-value {
  font-family: var(--fn);
  font-weight: 500;
  font-size: 52px;
  line-height: 1;
  letter-spacing: -2px;
  color: var(--text);
  transition: color .3s;
}
.hud-value.alert { color: var(--red); text-shadow: 0 0 30px rgba(232,0,45,0.4); }
.hud-unit {
  font-family: var(--fn);
  font-size: 9px;
  letter-spacing: 2px;
  color: var(--text-dim);
  margin-top: 4px;
}

/* Bottom gradient fade */
.bottom-fade {
  position: fixed;
  bottom: 0; left: 0; right: 0;
  height: 220px;
  background: linear-gradient(to top, rgba(13,15,18,0.75) 0%, transparent 100%);
  z-index: 15;
  pointer-events: none;
  transition: right .45s var(--panel-anim);
}
body.panel-open .bottom-fade {
  right: var(--panel-w);
}

/* ═══════════════════════════════════════
   SIDE TAB BUTTONS
═══════════════════════════════════════ */
.side-tabs {
  position: fixed;
  right: 0;
  top: 50%;
  transform: translateY(-50%);
  z-index: 30;
  display: flex;
  flex-direction: column;
  gap: 8px;
  transition: right .45s var(--panel-anim);
}
body.panel-open .side-tabs {
  right: var(--panel-w);
}

.tab-btn {
  writing-mode: vertical-rl;
  text-orientation: mixed;
  transform: rotate(180deg);
  font-family: var(--fn);
  font-size: 9px;
  letter-spacing: 3px;
  color: var(--text-dim);
  background: var(--surface);
  backdrop-filter: var(--blur);
  -webkit-backdrop-filter: var(--blur);
  border: 1px solid var(--border2);
  border-right: none;
  border-radius: 10px 0 0 10px;
  padding: 16px 9px;
  cursor: pointer;
  transition: all .25s var(--panel-anim);
  display: flex;
  align-items: center;
  gap: 8px;
  white-space: nowrap;
}
.tab-btn:hover {
  background: rgba(255,255,255,0.09);
  color: var(--text);
}
.tab-btn.active {
  background: rgba(255,255,255,0.1);
  border-color: rgba(255,255,255,0.25);
  color: var(--text);
}
.tab-btn.active.driver { border-color: rgba(232,0,45,0.4); color: var(--red); }
.tab-btn.active.car    { border-color: rgba(79,172,254,0.4); color: var(--blue); }

.tab-icon {
  font-size: 11px;
  transform: rotate(180deg);
}

/* ═══════════════════════════════════════
   SIDE PANEL
═══════════════════════════════════════ */
.side-panel {
  position: fixed;
  top: 0;
  right: calc(-1 * var(--panel-w));
  width: var(--panel-w);
  height: 100%;
  z-index: 25;
  background: var(--surface);
  backdrop-filter: var(--blur);
  -webkit-backdrop-filter: var(--blur);
  border-left: 1px solid var(--border2);
  transition: right .45s var(--panel-anim);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}
.side-panel.open {
  right: 0;
}
.side-panel::before {
  content:'';
  position:absolute; top:0; left:0; width:1px; height:100%;
  background: linear-gradient(to bottom, transparent, rgba(255,255,255,0.15), transparent);
  pointer-events:none;
}

.panel-header {
  padding: 64px 20px 16px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}
.panel-title {
  font-family: var(--fu);
  font-weight: 700;
  font-size: 15px;
  letter-spacing: 3px;
  color: var(--text);
  margin-bottom: 4px;
}
.panel-sub {
  font-family: var(--fn);
  font-size: 8.5px;
  letter-spacing: 2px;
  color: var(--text-dim);
}

.panel-body {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  scrollbar-width: none;
}
.panel-body::-webkit-scrollbar { display:none; }

/* ═══════════════════════════════════════
   PANEL CARDS
═══════════════════════════════════════ */
.pcard {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 14px 16px;
  position: relative;
  overflow: hidden;
  flex-shrink: 0;
}
.pcard::before {
  content:'';
  position:absolute; top:0; left:0; right:0; height:1px;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.14), transparent);
}
.pcard.alert-r { border-color: rgba(232,0,45,0.4); background: rgba(232,0,45,0.06); animation: cardpulse .9s ease-in-out infinite; }
@keyframes cardpulse { 0%,100%{box-shadow:none} 50%{box-shadow:0 0 18px rgba(232,0,45,0.15)} }

.pc-label {
  font-family: var(--fn);
  font-size: 8px;
  letter-spacing: 3px;
  color: var(--text-dim);
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 10px;
}
.pc-tag {
  font-size: 7.5px;
  letter-spacing: 1px;
  padding: 2px 8px;
  border-radius: 8px;
  border: 1px solid;
}
.pc-tag--g { color:var(--green); border-color:rgba(0,214,122,0.3); background:rgba(0,214,122,0.07); }
.pc-tag--r { color:var(--red);   border-color:rgba(232,0,45,0.3);  background:rgba(232,0,45,0.07); }
.pc-tag--a { color:var(--amber); border-color:rgba(245,166,35,0.3); background:rgba(245,166,35,0.07); }
.pc-tag--b { color:var(--blue);  border-color:rgba(79,172,254,0.3); background:rgba(79,172,254,0.07); }
.pc-tag--d { color:var(--text-dim); border-color:var(--border); background:transparent; }

.pc-num {
  font-family: var(--fn);
  font-weight: 500;
  line-height: 1;
  transition: color .3s, text-shadow .3s;
}
.pc-num--xl { font-size: 44px; letter-spacing: -1px; }
.pc-num--lg { font-size: 28px; }
.pc-num--md { font-size: 18px; }
.pc-num--sm { font-size: 12px; }
.pc-num--g  { color: var(--green); text-shadow: 0 0 18px rgba(0,214,122,0.35); }
.pc-num--r  { color: var(--red);   text-shadow: 0 0 16px rgba(232,0,45,0.35); }
.pc-num--a  { color: var(--amber); text-shadow: 0 0 16px rgba(245,166,35,0.3); }
.pc-num--w  { color: var(--text); }

.pc-unit { font-family:var(--fn); font-size:8px; letter-spacing:2px; color:var(--text-dim); margin-top:2px; }

/* bar */
.bar { width:100%; height:2px; background:rgba(255,255,255,0.06); border-radius:1px; overflow:hidden; margin-top:8px; }
.bar__fill { height:100%; border-radius:1px; transition:width .5s cubic-bezier(.16,1,.3,1), background .4s; }

/* heart */
.heart { font-size:18px; color:var(--red); filter:drop-shadow(0 0 7px rgba(232,0,45,0.7)); animation:hb 1s ease-in-out infinite; }
@keyframes hb { 0%,100%{transform:scale(1)} 14%{transform:scale(1.32)} 28%{transform:scale(1)} 42%{transform:scale(1.14)} }
.ecg-wrap { width:100%; height:28px; margin-top:6px; }
.ecg-wrap canvas { display:block; width:100%; height:100%; }

/* IR banner */
.ir-banner {
  display:flex; align-items:center; gap:8px;
  padding:9px 12px; border-radius:10px;
  border:1px solid var(--border);
  background:rgba(255,255,255,0.04);
  margin-bottom:10px;
  transition: all .3s;
}
.ir-banner.ALERT { background:rgba(232,0,45,0.08); border-color:rgba(232,0,45,0.45); animation:pillflash .7s ease-in-out infinite; }
.ir-txt { font-family:var(--fn); font-size:9px; letter-spacing:2.5px; transition:color .3s; color:var(--text-dim); }
.ir-txt.ALERT { color:var(--red); }

/* IR stat boxes */
.ir-boxes { display:grid; grid-template-columns:1fr 1fr 1fr; gap:6px; margin-bottom:8px; }
.ir-box {
  text-align:center; padding:8px 4px;
  background:rgba(255,255,255,0.03);
  border:1px solid var(--border);
  border-radius:10px;
}

/* log */
.log-row { font-family:var(--fn); font-size:7.5px; color:var(--text-dim); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-bottom:2px; }
.log-row.fresh { color:var(--text); }
.log-ts { color:rgba(255,255,255,0.14); margin-right:5px; }
.log-ok { color:var(--green); } .log-r { color:var(--red); }

/* raw input */
.raw-in {
  width:100%; background:rgba(255,255,255,0.03);
  border:1px solid var(--border); border-radius:8px;
  color:var(--text); font-family:var(--fn); font-size:8px; line-height:1.55;
  padding:8px 10px; resize:none; outline:none; height:90px;
  transition:border-color .2s;
}
.raw-in:focus { border-color:rgba(255,255,255,0.22); }
.raw-in::placeholder { color:rgba(255,255,255,0.1); }
.inj-row { display:flex; align-items:center; gap:8px; margin-top:6px; }
.inj-btn {
  background:rgba(255,255,255,0.06); border:1px solid var(--border2);
  color:var(--text); font-family:var(--fn); font-size:8px; letter-spacing:2px;
  padding:5px 14px; border-radius:8px; cursor:pointer;
  transition:background .2s;
}
.inj-btn:hover { background:rgba(255,255,255,0.12); }
.fb { font-family:var(--fn); font-size:8px; color:var(--text-dim); }
.fb--ok { color:var(--green); } .fb--err { color:var(--red); }

/* ═══════════════════════════════════════
   CAR CANVAS inside panel
═══════════════════════════════════════ */
.car-wrap {
  width: 100%;
  height: 160px;
  position: relative;
  border-radius: 10px;
  overflow: hidden;
  background: rgba(0,0,0,0.3);
  border: 1px solid var(--border);
}
.car-wrap canvas {
  position:absolute; inset:0; width:100%; height:100%;
}

/* mini stat grid */
.mini-grid { display:grid; grid-template-columns:1fr 1fr; gap:6px; }
.mg-cell {
  background:rgba(255,255,255,0.03); border:1px solid var(--border);
  border-radius:10px; padding:8px 10px;
}
.mg-k { font-family:var(--fn); font-size:7px; letter-spacing:1.5px; color:var(--text-dim); margin-bottom:3px; }
.mg-v { font-family:var(--fn); font-size:13px; font-weight:500; color:var(--text); }
</style>
</head>
<body>

<!-- MAP -->
<div id="mapCanvas"></div>

<!-- BOTTOM GRADIENT FADE -->
<div class="bottom-fade"></div>

<!-- TOP BAR -->
<div class="topbar">
  <div class="brand">TRACK<span>SIGHT</span></div>
  <div class="topbar-right">
    <div class="pill pill--g"><div class="dot dot--g"></div>ACTIVE FEED</div>
    <div class="pill pill--d" id="irPill"><div class="dot dot--a"></div>IR STANDBY</div>
    <div class="pill pill--d"><span id="lastUpd">AWAITING</span></div>
    <span id="clock">--:--:--</span>
  </div>
</div>

<!-- SIDE TAB BUTTONS -->
<div class="side-tabs">
  <button class="tab-btn driver" id="driverTab" onclick="togglePanel('driver')">
    <span class="tab-icon">♥</span>DRIVER STATS
  </button>
  <button class="tab-btn car" id="carTab" onclick="togglePanel('car')">
    <span class="tab-icon">⚙</span>CAR STATS
  </button>
</div>

<!-- DRIVER STATS PANEL -->
<div class="side-panel" id="driverPanel">
  <div class="panel-header">
    <div class="panel-title">DRIVER STATS</div>
    <div class="panel-sub">BIOMETRIC · CABIN · AIR QUALITY</div>
  </div>
  <div class="panel-body">

    <!-- PULSE -->
    <div class="pcard">
      <div class="pc-label">PULSE RATE <span class="pc-tag pc-tag--r" id="hrTag">MAX30102</span></div>
      <div style="display:flex;align-items:center;gap:14px;">
        <div>
          <span class="heart" id="heartIcon">♥</span>
          <div class="pc-num pc-num--xl pc-num--r" id="hrVal" style="margin-top:4px;">—</div>
          <div class="pc-unit">BPM</div>
        </div>
        <div style="flex:1;">
          <div class="ecg-wrap"><canvas id="ecgCanvas" height="28"></canvas></div>
          <div style="display:flex;justify-content:space-between;margin-top:8px;">
            <div><div class="pc-unit">STATUS</div><div class="pc-num pc-num--sm pc-num--g" id="hrStatus" style="margin-top:2px;">—</div></div>
            <div><div class="pc-unit">PEAK</div><div class="pc-num pc-num--sm pc-num--w" id="hrPeak" style="margin-top:2px;">—</div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- CABIN HEAT & HUMIDITY -->
    <div class="pcard">
      <div class="pc-label">CABIN ENVIRONMENT <span class="pc-tag pc-tag--a">DHT22</span></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <div>
          <div class="pc-unit">TEMPERATURE</div>
          <div style="display:flex;align-items:baseline;gap:4px;margin-top:4px;">
            <div class="pc-num pc-num--lg pc-num--a" id="tempVal">—</div>
            <div class="pc-unit">°C</div>
          </div>
          <div class="bar"><div class="bar__fill" id="tempBar" style="width:0%;background:var(--amber);"></div></div>
        </div>
        <div>
          <div class="pc-unit">HUMIDITY</div>
          <div style="display:flex;align-items:baseline;gap:4px;margin-top:4px;">
            <div class="pc-num pc-num--lg pc-num--g" id="humVal">—</div>
            <div class="pc-unit">%RH</div>
          </div>
          <div class="bar"><div class="bar__fill" id="humBar" style="width:0%;background:var(--green);"></div></div>
        </div>
      </div>
    </div>

    <!-- CABIN AIR QUALITY / GAS -->
    <div class="pcard">
      <div class="pc-label">CABIN AIR QUALITY <span class="pc-tag pc-tag--d" id="gasTag">MQ2</span></div>
      <div style="display:flex;align-items:baseline;gap:6px;">
        <div class="pc-num pc-num--lg pc-num--a" id="gasVal">—</div>
        <div class="pc-unit">PPM</div>
      </div>
      <div class="bar"><div class="bar__fill" id="gasBar" style="width:0%;background:var(--amber);"></div></div>
      <canvas id="gasArc" style="display:block;width:100%;height:50px;margin-top:6px;"></canvas>
      <div style="display:flex;justify-content:space-between;margin-top:4px;">
        <div><div class="pc-unit">STATUS</div><div class="pc-num pc-num--sm" id="gasStatus" style="color:var(--green);margin-top:2px;">CLEAR</div></div>
        <div style="text-align:right;"><div class="pc-unit">PEAK PPM</div><div class="pc-num pc-num--sm pc-num--w" id="gasPeak" style="margin-top:2px;">—</div></div>
      </div>
    </div>

    <!-- SESSION -->
    <div class="pcard">
      <div class="pc-label">SESSION <span id="uptime" style="font-family:var(--fn);font-size:8px;letter-spacing:2px;color:var(--text-dim);">00:00</span></div>
      <div class="mini-grid">
        <div class="mg-cell"><div class="mg-k">READINGS</div><div class="mg-v" id="sRead">0</div></div>
        <div class="mg-cell"><div class="mg-k">ALERTS</div><div class="mg-v" style="color:var(--red);" id="sAlert">0</div></div>
        <div class="mg-cell"><div class="mg-k">PEAK BPM</div><div class="mg-v" style="color:var(--red);" id="sPeakBpm">—</div></div>
        <div class="mg-cell"><div class="mg-k">GAS PEAK</div><div class="mg-v" style="color:var(--amber);" id="sPeakGas">—</div></div>
      </div>
    </div>

  </div>
</div>

<!-- CAR STATS PANEL -->
<div class="side-panel" id="carPanel">
  <div class="panel-header">
    <div class="panel-title">CAR STATS</div>
    <div class="panel-sub">IR SENSOR · CHASSIS · TELEMETRY</div>
  </div>
  <div class="panel-body">

    <!-- CAR AIRFLOW MODEL -->
    <div class="pcard">
      <div class="pc-label">AIRFLOW MODEL <span class="pc-tag pc-tag--b" id="flowLabel">—</span></div>
      <div class="car-wrap">
        <canvas id="carCanvas"></canvas>
      </div>
      <div style="display:flex;justify-content:space-between;margin-top:8px;">
        <div class="pc-unit">LEFT PROFILE — FORD FUSION AERO</div>
        <div class="pc-num pc-num--sm" id="carStatus" style="font-size:8px;letter-spacing:2px;color:var(--text-dim);">NOMINAL</div>
      </div>
    </div>

    <!-- ACCEL -->
    <div class="pcard">
      <div class="pc-label">ACCELERATION <span class="pc-tag pc-tag--d" id="magTag">—</span></div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:10px;">
        <div>
          <div style="font-family:var(--fn);font-size:7px;letter-spacing:1.5px;color:var(--text-dim);margin-bottom:4px;">X LAT.</div>
          <div style="height:60px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:6px;position:relative;overflow:hidden;">
            <div id="axFill" style="position:absolute;bottom:0;left:0;right:0;height:50%;background:var(--green);border-radius:6px 6px 0 0;transition:height .4s cubic-bezier(.16,1,.3,1);"></div>
          </div>
          <div style="font-family:var(--fn);font-size:11px;color:var(--text);margin-top:3px;" id="axVal">—</div>
          <div style="font-family:var(--fn);font-size:7px;color:var(--text-xs);">m/s²</div>
        </div>
        <div>
          <div style="font-family:var(--fn);font-size:7px;letter-spacing:1.5px;color:var(--text-dim);margin-bottom:4px;">Y LON.</div>
          <div style="height:60px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:6px;position:relative;overflow:hidden;">
            <div id="ayFill" style="position:absolute;bottom:0;left:0;right:0;height:50%;background:var(--amber);border-radius:6px 6px 0 0;transition:height .4s cubic-bezier(.16,1,.3,1);"></div>
          </div>
          <div style="font-family:var(--fn);font-size:11px;color:var(--text);margin-top:3px;" id="ayVal">—</div>
          <div style="font-family:var(--fn);font-size:7px;color:var(--text-xs);">m/s²</div>
        </div>
        <div>
          <div style="font-family:var(--fn);font-size:7px;letter-spacing:1.5px;color:var(--text-dim);margin-bottom:4px;">Z VER.</div>
          <div style="height:60px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:6px;position:relative;overflow:hidden;">
            <div id="azFill" style="position:absolute;bottom:0;left:0;right:0;height:50%;background:var(--green);border-radius:6px 6px 0 0;transition:height .4s cubic-bezier(.16,1,.3,1);"></div>
          </div>
          <div style="font-family:var(--fn);font-size:11px;color:var(--text);margin-top:3px;" id="azVal">—</div>
          <div style="font-family:var(--fn);font-size:7px;color:var(--text-xs);">m/s²</div>
        </div>
      </div>
      <div style="display:flex;align-items:baseline;gap:6px;">
        <div class="pc-num pc-num--md pc-num--g" id="magVal">—</div>
        <div class="pc-unit">m/s² RESULTANT</div>
      </div>
      <div class="bar"><div class="bar__fill" id="magBar" style="width:0%;background:var(--green);"></div></div>
    </div>

    <!-- IR OBSTACLES -->
    <div class="pcard" id="irCard">
      <div class="pc-label">IR OBSTACLES <span class="pc-tag pc-tag--r" id="irStag">STANDBY</span></div>
      <div class="ir-banner" id="irBanner">
        <div class="dot dot--a" id="irDot"></div>
        <div class="ir-txt" id="irTxt">AWAITING READING</div>
      </div>
      <div class="ir-boxes">
        <div class="ir-box">
          <div class="pc-num pc-num--md pc-num--r" id="irCount">0</div>
          <div class="pc-unit" style="text-align:center;margin-top:2px;">DETECTIONS</div>
        </div>
        <div class="ir-box">
          <div class="pc-num pc-num--md pc-num--g" id="irTotal">0</div>
          <div class="pc-unit" style="text-align:center;margin-top:2px;">READINGS</div>
        </div>
        <div class="ir-box">
          <div class="pc-num pc-num--md pc-num--a" id="irRate">—</div>
          <div class="pc-unit" style="text-align:center;margin-top:2px;">RATE</div>
        </div>
      </div>
      <div class="bar"><div class="bar__fill" id="irRateBar" style="width:0%;background:var(--red);"></div></div>
    </div>

    <!-- RAW ARDUINO OUTPUT -->
    <div class="pcard">
      <div class="pc-label">RAW ARDUINO OUTPUT <span class="pc-tag pc-tag--d" id="logBadge">0</span></div>
      <div id="logList" style="min-height:60px;">
        <div class="log-row" style="color:rgba(255,255,255,0.12);font-style:italic;">No events yet.</div>
      </div>
    </div>

    <!-- RAW INPUT -->
    <div class="pcard">
      <div class="pc-label">INJECT DATA <span class="pc-tag pc-tag--d">CTRL+ENTER</span></div>
      <textarea class="raw-in" id="rawIn" placeholder="IR: OBSTACLE DETECTED&#10;Accel: 0.162, 0.078, 1.013&#10;Temp (C): 25.49&#10;Humidity (%): 54.42&#10;BPM: 76&#10;Gas: 142"></textarea>
      <div class="inj-row">
        <button class="inj-btn" id="injBtn">▶ INJECT</button>
        <div class="fb" id="fb"></div>
      </div>
    </div>

  </div>
</div>

<!-- BOTTOM HUD -->
<div class="bottom-hud">
  <div class="hud-cluster">
    <div class="hud-stat">
      <div class="hud-label">SPEED</div>
      <div class="hud-value" id="hudSpeed">0.0</div>
      <div class="hud-unit">MPH</div>
    </div>
    <div class="hud-stat">
      <div class="hud-label">RESULTANT G</div>
      <div class="hud-value" id="hudG">0.00</div>
      <div class="hud-unit">G-FORCE</div>
    </div>
    <div class="hud-stat">
      <div class="hud-label">DISTANCE</div>
      <div class="hud-value" id="hudDist">0</div>
      <div class="hud-unit">READINGS</div>
    </div>
  </div>
</div>

<script>
// ══════════════════════════════════════════════════════════
// STATE
// ══════════════════════════════════════════════════════════
const S = {
  readings:0, irAlerts:0, irTotal:0,
  peakMag:0, lastData:null,
  accelHist:[], temps:[],
  hrBpm:0, hrPeak:0,
  gasPeak:0,
  t0:Date.now(), logLines:[],
  flowSpeed:0.45,
  ecgPhase:0, ecgBuf: new Array(120).fill(0),
  activePanel: null,
};
window.S = S;

// ══════════════════════════════════════════════════════════
// PANEL TOGGLE
// ══════════════════════════════════════════════════════════
function togglePanel(which) {
  const panels = { driver:'driverPanel', car:'carPanel' };
  const tabs   = { driver:'driverTab',   car:'carTab' };

  if (S.activePanel === which) {
    // close
    document.getElementById(panels[which]).classList.remove('open');
    document.getElementById(tabs[which]).classList.remove('active');
    document.body.classList.remove('panel-open');
    S.activePanel = null;
    // Resize map after transition
    setTimeout(()=>{ if(window._leafletMap) window._leafletMap.invalidateSize(); }, 500);
  } else {
    // close old
    if (S.activePanel) {
      document.getElementById(panels[S.activePanel]).classList.remove('open');
      document.getElementById(tabs[S.activePanel]).classList.remove('active');
    }
    // open new
    document.getElementById(panels[which]).classList.add('open');
    document.getElementById(tabs[which]).classList.add('active');
    document.body.classList.add('panel-open');
    S.activePanel = which;
    // resize car canvas when car panel opens
    if (which === 'car') setTimeout(sizeCar, 50);
    // Resize map after transition
    setTimeout(()=>{ if(window._leafletMap) window._leafletMap.invalidateSize(); }, 500);
  }
}

// ══════════════════════════════════════════════════════════
// CLOCK
// ══════════════════════════════════════════════════════════
function p2(n){return String(Math.floor(n)).padStart(2,'0');}
setInterval(()=>{
  const n=new Date();
  document.getElementById('clock').textContent=`${p2(n.getHours())}:${p2(n.getMinutes())}:${p2(n.getSeconds())}`;
  const s=(Date.now()-S.t0)/1000;
  document.getElementById('uptime').textContent=`${p2(s/60)}:${p2(s%60)}`;
},1000);

// ══════════════════════════════════════════════════════════
// MAP — initialised via module script below
// ══════════════════════════════════════════════════════════

// ══════════════════════════════════════════════════════════
// PARSER
// ══════════════════════════════════════════════════════════
function parse(raw){
  const r={ok:false};
  const ir=raw.match(/IR:\s*(.+)/i);
  if(ir) r.ir=ir[1].trim().toUpperCase().includes('OBSTACLE')?'OBSTACLE DETECTED':'CLEAR';
  const ac=raw.match(/Accel:\s*([-\d.]+),\s*([-\d.]+),\s*([-\d.]+)/i);
  if(ac){r.ax=+ac[1];r.ay=+ac[2];r.az=+ac[3];}
  const tp=raw.match(/Temp[^:]*:\s*([\d.]+)/i);
  if(tp) r.temp=+tp[1];
  const hm=raw.match(/Humidity[^:]*:\s*([\d.]+)/i);
  if(hm) r.hum=+hm[1];
  const bpm=raw.match(/(?:BPM|Pulse|HR):\s*([\d.]+)/i);
  if(bpm) r.bpm=+bpm[1];
  const gas=raw.match(/(?:Gas|MQ2|PPM):\s*([\d.]+)/i);
  if(gas) r.gas=+gas[1];
  r.ok=!!(ac||tp||bpm||gas||ir);
  return r;
}

// ══════════════════════════════════════════════════════════
// ECG
// ══════════════════════════════════════════════════════════
setInterval(()=>{
  if(!S.hrBpm)return;
  const period=60/S.hrBpm;
  S.ecgPhase=(S.ecgPhase+1/(period*60))%1;
  const p=S.ecgPhase;
  let v=0;
  if(p<0.08)v=0.12*Math.sin(p/0.08*Math.PI);
  else if(p<0.13)v=0;
  else if(p<0.15)v=-0.22*(p-0.13)/0.02;
  else if(p<0.19)v=Math.sin((p-0.15)/0.04*Math.PI);
  else if(p<0.23)v=-0.18*(0.23-p)/0.04;
  else if(p<0.38)v=0;
  else if(p<0.55)v=0.32*Math.sin((p-0.38)/0.17*Math.PI);
  S.ecgBuf.push(v);if(S.ecgBuf.length>120)S.ecgBuf.shift();
},1000/60);

function drawECG(){
  const el=document.getElementById('ecgCanvas');if(!el)return;
  const dpr=window.devicePixelRatio||1;
  const W=el.offsetWidth*dpr||200,H=28*dpr;
  if(el.width!==W||el.height!==H){el.width=W;el.height=H;}
  const ctx=el.getContext('2d');
  ctx.clearRect(0,0,W,H);
  if(!S.hrBpm){
    ctx.beginPath();ctx.moveTo(0,H/2);ctx.lineTo(W,H/2);
    ctx.strokeStyle='rgba(232,0,45,0.12)';ctx.lineWidth=1;
    ctx.setLineDash([3,7]);ctx.stroke();ctx.setLineDash([]);return;
  }
  const buf=S.ecgBuf,step=W/(buf.length-1),mid=H/2,amp=H*0.42;
  const gr=ctx.createLinearGradient(0,0,W,0);
  gr.addColorStop(0,'rgba(232,0,45,0.05)');gr.addColorStop(0.7,'rgba(232,0,45,0.5)');gr.addColorStop(1,'#e8002d');
  ctx.beginPath();
  buf.forEach((v,i)=>{const x=i*step,y=mid-v*amp;i?ctx.lineTo(x,y):ctx.moveTo(x,y);});
  ctx.strokeStyle=gr;ctx.lineWidth=1.5;ctx.shadowColor='#e8002d';ctx.shadowBlur=5;ctx.stroke();
}

// ══════════════════════════════════════════════════════════
// GAS ARC
// ══════════════════════════════════════════════════════════
function drawGasArc(ppm){
  const el=document.getElementById('gasArc');if(!el)return;
  const dpr=window.devicePixelRatio||1;
  const W=el.offsetWidth*dpr||200,H=50*dpr;
  if(el.width!==W||el.height!==H){el.width=W;el.height=H;}
  const ctx=el.getContext('2d');ctx.clearRect(0,0,W,H);
  const cx=W/2,cy=H,r=Math.min(W/2,H)-6*dpr;
  const pct=Math.min(1,(ppm||0)/1000);
  const col=ppm>700?'#e8002d':ppm>300?'#f5a623':'#00d67a';
  ctx.beginPath();ctx.arc(cx,cy,r,Math.PI,0);
  ctx.strokeStyle='rgba(255,255,255,0.06)';ctx.lineWidth=4*dpr;ctx.lineCap='round';ctx.stroke();
  if(pct>0){
    const gr=ctx.createLinearGradient(cx-r,0,cx+r,0);
    gr.addColorStop(0,'#00d67a');gr.addColorStop(0.5,'#f5a623');gr.addColorStop(1,'#e8002d');
    ctx.beginPath();ctx.arc(cx,cy,r,Math.PI,Math.PI+pct*Math.PI);
    ctx.strokeStyle=gr;ctx.lineWidth=4*dpr;ctx.shadowColor=col;ctx.shadowBlur=8;ctx.lineCap='round';ctx.stroke();ctx.shadowBlur=0;
  }
  const na=Math.PI+pct*Math.PI;
  ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(cx+Math.cos(na)*(r-6*dpr),cy+Math.sin(na)*(r-6*dpr));
  ctx.strokeStyle='rgba(255,255,255,0.85)';ctx.lineWidth=1.5*dpr;ctx.shadowColor='#fff';ctx.shadowBlur=4;ctx.stroke();
  ctx.beginPath();ctx.arc(cx,cy,3.5*dpr,0,Math.PI*2);
  ctx.fillStyle=col;ctx.shadowColor=col;ctx.shadowBlur=7;ctx.fill();ctx.shadowBlur=0;
}

// ══════════════════════════════════════════════════════════
// LOG
// ══════════════════════════════════════════════════════════
function addLog(d,ts){
  const t=ts.toLocaleTimeString('en-US',{hour12:false});
  const ic=d.ir==='OBSTACLE DETECTED'?'log-r':'log-ok';
  const is=d.ir==='OBSTACLE DETECTED'?'⚠ ':'✓ ';
  const ac=d.ax!==undefined?`A:[${d.ax.toFixed(2)},${d.ay.toFixed(2)},${d.az.toFixed(2)}] `:'';
  const bp=d.bpm!==undefined?`${d.bpm}bpm `:'';
  const gs=d.gas!==undefined?`${d.gas}ppm`:'';
  S.logLines.unshift(`<div class="log-row fresh"><span class="log-ts">${t}</span><span class="${ic}">${is}</span>${ac}${bp}${gs}</div>`);
  if(S.logLines.length>7)S.logLines.pop();
  document.getElementById('logList').innerHTML=S.logLines.join('');
  document.getElementById('logBadge').textContent=S.readings;
  setTimeout(()=>{const e=document.getElementById('logList').firstElementChild;if(e)e.classList.remove('fresh');},450);
}

// ══════════════════════════════════════════════════════════
// UPDATE
// ══════════════════════════════════════════════════════════
function update(d){
  const now=new Date();
  S.readings++;S.lastData=d;

  if(d.ax!==undefined){
    const mag=Math.sqrt(d.ax**2+d.ay**2+d.az**2);
    document.getElementById('axVal').textContent=d.ax.toFixed(2);
    document.getElementById('ayVal').textContent=d.ay.toFixed(2);
    document.getElementById('azVal').textContent=d.az.toFixed(2);
    document.getElementById('magVal').textContent=mag.toFixed(2);
    const bh=v=>Math.min(100,Math.max(0,((v/5)+1)/2*100));
    document.getElementById('axFill').style.height=bh(d.ax)+'%';
    document.getElementById('ayFill').style.height=bh(d.ay)+'%';
    document.getElementById('azFill').style.height=bh(d.az)+'%';
    const mc=mag>10?'var(--red)':mag>5?'var(--amber)':'var(--green)';
    document.getElementById('magBar').style.width=Math.min(100,mag/15*100)+'%';
    document.getElementById('magBar').style.background=mc;
    const mt=document.getElementById('magTag');
    mt.textContent=mag>10?'HIGH':mag>5?'MOD':'NOMINAL';
    mt.className=`pc-tag ${mag>10?'pc-tag--r':mag>5?'pc-tag--a':'pc-tag--g'}`;
    S.flowSpeed=Math.max(0.06,Math.min(1,mag/12));
    document.getElementById('flowLabel').textContent=`AIRFLOW ${(S.flowSpeed*100).toFixed(0)}%`;
    if(mag>S.peakMag){S.peakMag=mag;}
    // HUD — speed in MPH (simulated: mag * 25 for visual feel)
    const mph = mag * 25;
    document.getElementById('hudSpeed').textContent=mph.toFixed(1);
    document.getElementById('hudG').textContent=(mag/9.81).toFixed(2);
    const hv=document.getElementById('hudSpeed');
    hv.classList.toggle('alert',mag>10);
  }

  if(d.temp!==undefined){
    document.getElementById('tempVal').textContent=d.temp.toFixed(1);
    document.getElementById('tempBar').style.width=Math.min(100,(d.temp-10)/40*100)+'%';
    S.temps.push(d.temp);if(S.temps.length>60)S.temps.shift();
  }
  if(d.hum!==undefined){
    document.getElementById('humVal').textContent=d.hum.toFixed(1);
    document.getElementById('humBar').style.width=Math.min(100,d.hum)+'%';
  }

  if(d.bpm!==undefined){
    S.hrBpm=d.bpm;
    document.getElementById('hrVal').textContent=d.bpm.toFixed(0);
    document.getElementById('hrStatus').textContent=d.bpm>100?'ELEVATED':d.bpm<50?'LOW':'NOMINAL';
    document.getElementById('hrStatus').style.color=d.bpm>100?'var(--red)':d.bpm<50?'var(--amber)':'var(--green)';
    document.getElementById('heartIcon').style.animationDuration=(60/d.bpm)+'s';
    if(d.bpm>S.hrPeak){S.hrPeak=d.bpm;document.getElementById('hrPeak').textContent=d.bpm.toFixed(0);document.getElementById('sPeakBpm').textContent=d.bpm.toFixed(0);}
  }

  if(d.gas!==undefined){
    document.getElementById('gasVal').textContent=d.gas.toFixed(0);
    const gcol=d.gas>700?'var(--red)':d.gas>300?'var(--amber)':'var(--green)';
    document.getElementById('gasBar').style.width=Math.min(100,d.gas/1000*100)+'%';
    document.getElementById('gasBar').style.background=gcol;
    const gs=document.getElementById('gasTag'),gst=document.getElementById('gasStatus');
    if(d.gas>700){gs.className='pc-tag pc-tag--r';gs.textContent='DANGER';gst.textContent='DANGER';gst.style.color='var(--red)';}
    else if(d.gas>300){gs.className='pc-tag pc-tag--a';gs.textContent='ELEVATED';gst.textContent='ELEVATED';gst.style.color='var(--amber)';}
    else{gs.className='pc-tag pc-tag--g';gs.textContent='CLEAR';gst.textContent='CLEAR';gst.style.color='var(--green)';}
    if(d.gas>S.gasPeak){S.gasPeak=d.gas;document.getElementById('gasPeak').textContent=d.gas.toFixed(0);document.getElementById('sPeakGas').textContent=d.gas.toFixed(0);}
    drawGasArc(d.gas);
  }

  if(d.ir!==undefined){
    S.irTotal++;const det=d.ir==='OBSTACLE DETECTED';
    if(det)S.irAlerts++;
    const banner=document.getElementById('irBanner'),txt=document.getElementById('irTxt');
    const stag=document.getElementById('irStag'),idot=document.getElementById('irDot');
    const irpill=document.getElementById('irPill');
    if(det){
      banner.className='ir-banner ALERT';txt.className='ir-txt ALERT';txt.textContent='⚠  OBSTACLE DETECTED';
      stag.className='pc-tag pc-tag--r';stag.textContent='ALERT';idot.className='dot dot--r';
      irpill.className='pill pill--r';irpill.innerHTML='<div class="dot dot--r"></div>IR ALERT';
      document.getElementById('carStatus').textContent='⚠ OBSTACLE';document.getElementById('carStatus').style.color='var(--red)';
    }else{
      banner.className='ir-banner';txt.className='ir-txt';txt.textContent='✓  CLEAR';
      stag.className='pc-tag pc-tag--g';stag.textContent='CLEAR';idot.className='dot dot--g';
      irpill.className='pill pill--g';irpill.innerHTML='<div class="dot dot--g"></div>IR CLEAR';
      document.getElementById('carStatus').textContent='NOMINAL';document.getElementById('carStatus').style.color='var(--text-dim)';
    }
    document.getElementById('irCount').textContent=S.irAlerts;
    document.getElementById('irTotal').textContent=S.irTotal;
    const rate=S.irTotal>0?(S.irAlerts/S.irTotal*100):0;
    document.getElementById('irRate').textContent=rate.toFixed(0)+'%';
    document.getElementById('irRateBar').style.width=rate+'%';
    document.getElementById('sAlert').textContent=S.irAlerts;
  }

  document.getElementById('lastUpd').textContent='LAST '+now.toLocaleTimeString('en-US',{hour12:false});
  document.getElementById('hudDist').textContent=S.readings;
  document.getElementById('sRead').textContent=S.readings;
  addLog(d,now);
}

// ══════════════════════════════════════════════════════════
// INJECT
// ══════════════════════════════════════════════════════════
document.getElementById('injBtn').addEventListener('click',()=>{
  const raw=document.getElementById('rawIn').value;
  const fb=document.getElementById('fb');
  const d=parse(raw);
  if(d.ok){update(d);fb.className='fb fb--ok';fb.textContent='✓ OK';setTimeout(()=>fb.textContent='',2000);}
  else{fb.className='fb fb--err';fb.textContent='✗ FAIL';setTimeout(()=>fb.textContent='',3000);}
});
document.getElementById('rawIn').addEventListener('keydown',e=>{
  if((e.ctrlKey||e.metaKey)&&e.key==='Enter')document.getElementById('injBtn').click();
});


// ══════════════════════════════════════════════════════════
// CAR AIRFLOW MODEL
// Front bumper / nose faces RIGHT. Car travels RIGHT.
// Air streams flow LEFT → RIGHT showing aerodynamic forces.
//
// Layout (x=0 LEFT = tail, x=1 RIGHT = nose/front):
//   REAR (trunk, taillights) — LEFT
//   COCKPIT / ROOF — centre
//   HOOD / FRONT BUMPER — RIGHT
// ══════════════════════════════════════════════════════════
function sizeCar(){
  const el=document.getElementById('carCanvas');if(!el)return;
  const p=el.parentElement;
  const dpr=window.devicePixelRatio||1;
  el.width=p.offsetWidth*dpr;
  el.height=p.offsetHeight*dpr;
  el.style.width=p.offsetWidth+'px';
  el.style.height=p.offsetHeight+'px';
  const W=el.width,H=el.height;
  airParticles.forEach(p=>initAP(p,W,H));
}

// Air particles — flow left-to-right
const NAIR=90;
const airParticles=[];
function initAP(p,W,H){
  p.x=-20-Math.random()*80;
  p.baseY=4+Math.random()*(H-8);
  p.y=p.baseY;
  p.speed=0.4+Math.random()*0.6;
  p.len=14+Math.random()*30;
  p.alpha=0.22+Math.random()*0.5;
  p.deflected=false;
  p.vx=0; p.vy=0;
  p.colorIdx=Math.floor(Math.random()*6);
}
for(let i=0;i<NAIR;i++) airParticles.push({x:0,baseY:0,y:0,speed:0,len:0,alpha:0,deflected:false,vx:0,vy:0,colorIdx:0});

let carT2=0;

// FLIPPED: tail LEFT (nx=0), nose/front RIGHT (nx=1). Sleeker roof.
const CAR_HULL = [
  [0.02,0.62],[0.02,0.40],
  [0.04,0.36],[0.08,0.30],[0.14,0.24],
  [0.22,0.18],
  [0.35,0.14],[0.48,0.12],[0.58,0.13],[0.65,0.16],
  [0.72,0.24],[0.76,0.30],
  [0.82,0.36],[0.88,0.40],[0.94,0.44],[0.97,0.48],[0.98,0.52],
  [0.98,0.60],[0.96,0.64],
  [0.88,0.66],[0.78,0.68],[0.22,0.68],[0.12,0.66],[0.06,0.64],[0.02,0.62],
];

function drawCarModel(){
  carT2+=0.01;
  const el=document.getElementById('carCanvas');if(!el||!el.width)return;
  const dpr=window.devicePixelRatio||1;
  const W=el.width,H=el.height;
  const ctx=el.getContext('2d');
  ctx.clearRect(0,0,W,H);

  const carW=W*0.82, carH=H*0.72;
  const carX=(W-carW)*0.50, carY=(H-carH)*0.42;
  const groundY=carY+carH;

  function cc(nx,ny){return{x:carX+nx*carW, y:carY+ny*carH};}
  const hullCanvas=CAR_HULL.map(([nx,ny])=>cc(nx,ny));

  // ── STREAMLINE COLOURS (like reference diagram) ──
  const SC=[
    {r:232,g:60,b:60},   // red (drag)
    {r:245,g:166,b:35},  // orange
    {r:240,g:220,b:50},  // yellow
    {r:0,g:200,b:100},   // green
    {r:79,g:172,b:254},  // blue (laminar)
    {r:160,g:100,b:240}, // purple (ground)
  ];

  const spd=S.flowSpeed;
  const irAlert=S.lastData&&S.lastData.ir==='OBSTACLE DETECTED';

  // Helper: sample hull Y at normalised x
  function hullYAt(nx){
    for(let i=0;i<CAR_HULL.length-1;i++){
      const [ax,ay]=CAR_HULL[i],[bx,by]=CAR_HULL[i+1];
      const mn=Math.min(ax,bx),mx=Math.max(ax,bx);
      if(nx>=mn-0.01&&nx<=mx+0.01){
        const t=(nx-ax)/(bx-ax+0.0001);
        if(t>=0&&t<=1) return ay+t*(by-ay);
      }
    }
    return null;
  }

  // ── STATIC LAYERED STREAMLINES ──────────────────
  const NSTREAM=16;
  for(let si=0;si<NSTREAM;si++){
    const yBase=0.01+si*0.065;
    const isTop=yBase<0.40;
    const isBot=yBase>0.62;
    const ci=isBot?5:isTop?Math.min(5,Math.floor(si*5/NSTREAM)):4;
    const col=SC[ci];
    const ph=si*0.9;
    const amp=isBot?0.008:0.006+Math.random()*0.004;
    const alpha=0.30+0.12*Math.sin(carT2*0.7+ph);

    ctx.beginPath();
    const steps=80;
    for(let s=0;s<=steps;s++){
      const nx=s/steps;
      let ny=yBase+amp*Math.sin(nx*Math.PI*2.5+carT2*1.1+ph);

      // Deflect around hull
      const hy=hullYAt(nx);
      if(hy!==null){
        const margin=0.05+Math.abs(yBase-0.40)*0.06;
        if(isTop&&ny>hy-margin){
          ny=hy-margin-(0.40-yBase)*0.18;
        }else if(isBot&&ny<hy+margin){
          ny=hy+margin+(yBase-0.62)*0.15;
        }else if(!isTop&&!isBot){
          if(ny>hy-margin&&ny<hy+margin){
            ny=yBase<0.50?hy-margin-0.02:hy+margin+0.02;
          }
        }
      }

      const pt=cc(nx,ny);
      s===0?ctx.moveTo(pt.x,pt.y):ctx.lineTo(pt.x,pt.y);
    }

    ctx.strokeStyle=irAlert
      ?`rgba(232,${60+si*6},${60+si*4},${alpha})`
      :`rgba(${col.r},${col.g},${col.b},${alpha})`;
    ctx.lineWidth=(0.9+0.3*Math.sin(carT2+ph))*dpr;
    ctx.shadowColor=`rgba(${col.r},${col.g},${col.b},0.25)`;
    ctx.shadowBlur=4*dpr;
    ctx.stroke();ctx.shadowBlur=0;
  }

  // ── ANIMATED FLOW PARTICLES ─────────────────────
  airParticles.forEach(p=>{
    const vx=(0.6+p.speed*0.6)*spd*W*0.006;
    p.x+=vx;

    let deflect=false;
    for(let i=0;i<hullCanvas.length-1;i++){
      const a=hullCanvas[i],b=hullCanvas[i+1];
      const minX=Math.min(a.x,b.x)-4,maxX=Math.max(a.x,b.x)+4;
      if(p.x>=minX&&p.x<=maxX){
        const t2=(p.x-a.x)/(b.x-a.x+0.001);
        const hY=a.y+t2*(b.y-a.y);
        if(Math.abs(p.y-hY)<carH*0.18){
          const isAbove=p.baseY<hY;
          const flow=Math.sin(carT2*1.4+p.speed*2)*carH*0.01;
          const tgt=isAbove?hY-carH*0.06-flow:hY+carH*0.06+flow;
          p.y+=(tgt-p.y)*0.12;
          deflect=true;break;
        }
      }
    }
    if(!deflect) p.y+=(p.baseY-p.y)*0.04;
    if(p.x>W+60) initAP(p,W,H);

    const col=SC[p.colorIdx%SC.length];
    const bc=irAlert?`rgba(232,80,80,${p.alpha*0.6})`:`rgba(${col.r},${col.g},${col.b},${p.alpha*0.65})`;
    const fc=irAlert?'rgba(232,80,80,0)':`rgba(${col.r},${col.g},${col.b},0)`;
    const grad=ctx.createLinearGradient(p.x-p.len,p.y,p.x,p.y);
    grad.addColorStop(0,fc);grad.addColorStop(1,bc);
    ctx.beginPath();ctx.moveTo(p.x-p.len,p.y);ctx.lineTo(p.x,p.y);
    ctx.strokeStyle=grad;ctx.lineWidth=(0.6+p.alpha*0.5)*dpr;
    if(deflect){ctx.shadowColor=`rgba(${col.r},${col.g},${col.b},0.2)`;ctx.shadowBlur=3;}else{ctx.shadowBlur=0;}
    ctx.stroke();ctx.shadowBlur=0;
  });

  // ── HELPERS ─────────────────────────────────────
  const STROKE_COL='rgba(220,225,235,0.85)';
  function poly(pts,fill,lw,blur){
    const mp=pts.map(([nx,ny])=>cc(nx,ny));
    ctx.beginPath();mp.forEach(({x,y},i)=>i?ctx.lineTo(x,y):ctx.moveTo(x,y));ctx.closePath();
    if(fill){ctx.fillStyle=fill;ctx.fill();}
    ctx.strokeStyle=STROKE_COL;ctx.lineWidth=lw*dpr;
    ctx.shadowColor='rgba(200,210,230,0.4)';ctx.shadowBlur=blur*dpr;ctx.stroke();ctx.shadowBlur=0;
  }
  function line(x1,y1,x2,y2,lw,col,blur){
    col=col||STROKE_COL;blur=blur||0;
    const a=cc(x1,y1),b=cc(x2,y2);
    ctx.beginPath();ctx.moveTo(a.x,a.y);ctx.lineTo(b.x,b.y);
    ctx.strokeStyle=col;ctx.lineWidth=lw*dpr;ctx.shadowBlur=blur*dpr;ctx.stroke();ctx.shadowBlur=0;
  }

  // ══════════════════════════════════════════════
  // FORD FUSION — FLIPPED (nose RIGHT), SLEEKER ROOF
  // ══════════════════════════════════════════════

  // Main body shell with bezier roof
  ctx.beginPath();
  let p0=cc(0.02,0.62);ctx.moveTo(p0.x,p0.y);
  let p1;
  p1=cc(0.02,0.40);ctx.lineTo(p1.x,p1.y);
  p1=cc(0.04,0.36);ctx.lineTo(p1.x,p1.y);
  p1=cc(0.08,0.30);ctx.lineTo(p1.x,p1.y);
  p1=cc(0.14,0.24);ctx.lineTo(p1.x,p1.y);
  // Sleek roof arc (bezier)
  {const c1=cc(0.28,0.08),c2=cc(0.56,0.08),e=cc(0.65,0.16);
  ctx.bezierCurveTo(c1.x,c1.y,c2.x,c2.y,e.x,e.y);}
  p1=cc(0.72,0.24);ctx.lineTo(p1.x,p1.y);
  p1=cc(0.76,0.30);ctx.lineTo(p1.x,p1.y);
  p1=cc(0.82,0.36);ctx.lineTo(p1.x,p1.y);
  {const c1=cc(0.90,0.42),e=cc(0.98,0.52);
  ctx.quadraticCurveTo(c1.x,c1.y,e.x,e.y);}
  p1=cc(0.98,0.60);ctx.lineTo(p1.x,p1.y);
  p1=cc(0.96,0.64);ctx.lineTo(p1.x,p1.y);
  p1=cc(0.88,0.66);ctx.lineTo(p1.x,p1.y);
  p1=cc(0.78,0.68);ctx.lineTo(p1.x,p1.y);
  p1=cc(0.22,0.68);ctx.lineTo(p1.x,p1.y);
  p1=cc(0.12,0.66);ctx.lineTo(p1.x,p1.y);
  p1=cc(0.06,0.64);ctx.lineTo(p1.x,p1.y);
  ctx.closePath();
  ctx.fillStyle='rgba(220,225,235,0.05)';ctx.fill();
  ctx.strokeStyle=STROKE_COL;ctx.lineWidth=1.8*dpr;
  ctx.shadowColor='rgba(200,210,230,0.5)';ctx.shadowBlur=18*dpr;ctx.stroke();ctx.shadowBlur=0;

  // Hood
  poly([[0.76,0.30],[0.82,0.36],[0.88,0.40],[0.94,0.44],[0.94,0.56],[0.76,0.56]],'rgba(220,225,235,0.03)',0.6,4);
  line(0.76,0.36,0.92,0.42,0.7,'rgba(220,225,235,0.22)',3);

  // Windshield
  poly([[0.65,0.16],[0.72,0.24],[0.76,0.30],[0.76,0.44],[0.65,0.44]],'rgba(79,172,254,0.12)',1.2,8);

  // Sleek roof highlight (bezier)
  ctx.beginPath();
  {const a=cc(0.14,0.24),c1=cc(0.28,0.08),c2=cc(0.56,0.08),e=cc(0.65,0.16);
  ctx.moveTo(a.x,a.y);ctx.bezierCurveTo(c1.x,c1.y,c2.x,c2.y,e.x,e.y);}
  ctx.strokeStyle='rgba(220,225,235,0.75)';ctx.lineWidth=1.6*dpr;
  ctx.shadowColor='rgba(200,210,230,0.6)';ctx.shadowBlur=12*dpr;ctx.stroke();ctx.shadowBlur=0;

  // Roof rail
  ctx.beginPath();
  {const a=cc(0.18,0.22),c1=cc(0.30,0.10),c2=cc(0.54,0.10),e=cc(0.64,0.17);
  ctx.moveTo(a.x,a.y);ctx.bezierCurveTo(c1.x,c1.y,c2.x,c2.y,e.x,e.y);}
  ctx.strokeStyle='rgba(220,225,235,0.12)';ctx.lineWidth=0.5*dpr;ctx.stroke();

  // Rear window
  poly([[0.08,0.30],[0.14,0.24],[0.22,0.18],[0.22,0.44],[0.08,0.44]],'rgba(79,172,254,0.08)',0.9,5);
  // Rear door window
  poly([[0.22,0.18],[0.38,0.14],[0.38,0.44],[0.22,0.44]],'rgba(79,172,254,0.06)',0.7,3);
  // Front door window
  poly([[0.38,0.14],[0.58,0.13],[0.65,0.16],[0.65,0.44],[0.38,0.44]],'rgba(79,172,254,0.06)',0.7,3);
  // B-Pillar
  line(0.38,0.14,0.38,0.44,1.8,'rgba(220,225,235,0.5)',4);
  // C-Pillar
  line(0.22,0.19,0.22,0.44,1.2,'rgba(220,225,235,0.35)',3);
  // Door line
  line(0.38,0.44,0.38,0.64,0.8,'rgba(220,225,235,0.18)',2);
  // Door handles
  {const dp=cc(0.30,0.46);ctx.beginPath();ctx.roundRect(dp.x,dp.y,carW*0.035,carH*0.02,2);ctx.fillStyle='rgba(220,225,235,0.16)';ctx.fill();}
  {const dp=cc(0.52,0.46);ctx.beginPath();ctx.roundRect(dp.x,dp.y,carW*0.035,carH*0.02,2);ctx.fillStyle='rgba(220,225,235,0.16)';ctx.fill();}

  // Trunk
  poly([[0.02,0.40],[0.04,0.36],[0.08,0.30],[0.08,0.52],[0.02,0.52]],'rgba(220,225,235,0.03)',0.6,3);
  line(0.08,0.30,0.08,0.52,0.5,'rgba(220,225,235,0.12)',2);

  // Side skirt & character line
  line(0.06,0.64,0.96,0.64,1.0,'rgba(220,225,235,0.25)',4);
  line(0.06,0.50,0.94,0.50,0.5,'rgba(220,225,235,0.10)',2);

  // Taillight (left)
  {const tp=cc(0.02,0.46);
  ctx.beginPath();ctx.ellipse(tp.x,tp.y,carW*0.010,carH*0.04,0,0,Math.PI*2);
  ctx.fillStyle='rgba(232,0,45,0.5)';ctx.shadowColor='rgba(232,0,45,0.6)';ctx.shadowBlur=12;ctx.fill();
  ctx.beginPath();ctx.ellipse(tp.x,tp.y,carW*0.005,carH*0.02,0,0,Math.PI*2);
  ctx.fillStyle='rgba(232,0,45,0.9)';ctx.fill();ctx.shadowBlur=0;}

  // Headlight (right)
  {const hp=cc(0.97,0.52);
  ctx.beginPath();ctx.ellipse(hp.x,hp.y,carW*0.018,carH*0.035,0,0,Math.PI*2);
  ctx.fillStyle='rgba(255,255,220,0.3)';ctx.shadowColor='rgba(255,255,200,0.6)';ctx.shadowBlur=14;ctx.fill();
  ctx.beginPath();ctx.ellipse(hp.x,hp.y,carW*0.008,carH*0.015,0,0,Math.PI*2);
  ctx.fillStyle='rgba(255,255,255,0.75)';ctx.fill();ctx.shadowBlur=0;}

  // Front grille (right)
  poly([[0.96,0.48],[0.98,0.52],[0.98,0.60],[0.96,0.64],[0.94,0.56],[0.94,0.48]],'rgba(220,225,235,0.06)',0.8,5);
  for(let i=0;i<3;i++){line(0.95,0.50+i*0.04,0.97,0.50+i*0.04,0.4,'rgba(220,225,235,0.10)',0);}
  {const fp=cc(0.96,0.54);ctx.beginPath();ctx.ellipse(fp.x,fp.y,carW*0.007,carH*0.012,0,0,Math.PI*2);
  ctx.strokeStyle='rgba(79,172,254,0.45)';ctx.lineWidth=0.7*dpr;ctx.stroke();}

  // Rear bumper & exhaust
  poly([[0.02,0.52],[0.06,0.52],[0.06,0.64],[0.02,0.62]],'rgba(220,225,235,0.03)',0.6,3);
  {const exP=cc(0.04,0.65);ctx.beginPath();ctx.ellipse(exP.x,exP.y,carW*0.007,carH*0.010,0,0,Math.PI*2);
  ctx.fillStyle='rgba(80,80,85,0.5)';ctx.strokeStyle='rgba(220,225,235,0.2)';ctx.lineWidth=0.7*dpr;ctx.fill();ctx.stroke();}

  // Rear wheel (left)
  const rwRx=carW*0.052,rwRy=carH*0.13;
  const rwCX=carX+carW*0.17,rwCY=carY+carH*0.66;
  ctx.beginPath();ctx.arc(rwCX,rwCY,rwRy*1.12,Math.PI,0);ctx.strokeStyle='rgba(220,225,235,0.25)';ctx.lineWidth=1.0*dpr;ctx.stroke();
  ctx.beginPath();ctx.ellipse(rwCX,rwCY,rwRx,rwRy,0,0,Math.PI*2);ctx.fillStyle='rgba(25,30,38,0.9)';ctx.fill();
  ctx.strokeStyle=STROKE_COL;ctx.lineWidth=1.4*dpr;ctx.shadowColor='rgba(200,210,230,0.3)';ctx.shadowBlur=8*dpr;ctx.stroke();ctx.shadowBlur=0;
  ctx.beginPath();ctx.ellipse(rwCX,rwCY,rwRx*0.5,rwRy*0.5,0,0,Math.PI*2);ctx.fillStyle='rgba(220,225,235,0.07)';ctx.fill();ctx.strokeStyle='rgba(220,225,235,0.22)';ctx.lineWidth=0.6*dpr;ctx.stroke();
  for(let i=0;i<5;i++){const a=i/5*Math.PI*2+carT2*0.7;ctx.beginPath();ctx.moveTo(rwCX+Math.cos(a)*rwRx*0.18,rwCY+Math.sin(a)*rwRy*0.18);ctx.lineTo(rwCX+Math.cos(a)*rwRx*0.45,rwCY+Math.sin(a)*rwRy*0.45);ctx.strokeStyle='rgba(220,225,235,0.18)';ctx.lineWidth=1.0*dpr;ctx.stroke();}
  ctx.beginPath();ctx.ellipse(rwCX,rwCY,rwRx*0.12,rwRy*0.12,0,0,Math.PI*2);ctx.fillStyle='rgba(220,225,235,0.25)';ctx.fill();

  // Front wheel (right)
  const fwRx=carW*0.052,fwRy=carH*0.13;
  const fwCX=carX+carW*0.83,fwCY=carY+carH*0.66;
  ctx.beginPath();ctx.arc(fwCX,fwCY,fwRy*1.12,Math.PI,0);ctx.strokeStyle='rgba(220,225,235,0.25)';ctx.lineWidth=1.0*dpr;ctx.stroke();
  ctx.beginPath();ctx.ellipse(fwCX,fwCY,fwRx,fwRy,0,0,Math.PI*2);ctx.fillStyle='rgba(25,30,38,0.9)';ctx.fill();
  ctx.strokeStyle=STROKE_COL;ctx.lineWidth=1.4*dpr;ctx.shadowColor='rgba(200,210,230,0.3)';ctx.shadowBlur=8*dpr;ctx.stroke();ctx.shadowBlur=0;
  ctx.beginPath();ctx.ellipse(fwCX,fwCY,fwRx*0.5,fwRy*0.5,0,0,Math.PI*2);ctx.fillStyle='rgba(220,225,235,0.07)';ctx.fill();ctx.strokeStyle='rgba(220,225,235,0.22)';ctx.lineWidth=0.6*dpr;ctx.stroke();
  for(let i=0;i<5;i++){const a=i/5*Math.PI*2+carT2*0.9;ctx.beginPath();ctx.moveTo(fwCX+Math.cos(a)*fwRx*0.18,fwCY+Math.sin(a)*fwRy*0.18);ctx.lineTo(fwCX+Math.cos(a)*fwRx*0.45,fwCY+Math.sin(a)*fwRy*0.45);ctx.strokeStyle='rgba(220,225,235,0.18)';ctx.lineWidth=1.0*dpr;ctx.stroke();}
  ctx.beginPath();ctx.ellipse(fwCX,fwCY,fwRx*0.12,fwRy*0.12,0,0,Math.PI*2);ctx.fillStyle='rgba(220,225,235,0.25)';ctx.fill();

  // Ground shadow & line
  const sg=ctx.createRadialGradient(W*0.5,groundY,0,W*0.5,groundY,carW*0.48);
  sg.addColorStop(0,'rgba(220,225,235,0.05)');sg.addColorStop(1,'transparent');
  ctx.beginPath();ctx.ellipse(W*0.5,groundY+carH*0.01,carW*0.46,carH*0.025,0,0,Math.PI*2);ctx.fillStyle=sg;ctx.fill();
  ctx.beginPath();ctx.moveTo(carX-30,groundY);ctx.lineTo(carX+carW+30,groundY);ctx.strokeStyle='rgba(220,225,235,0.07)';ctx.lineWidth=1*dpr;ctx.stroke();

  // Force arrows
  // Downforce (top)
  {const ax=cc(0.45,0.02);ctx.beginPath();ctx.moveTo(ax.x-6*dpr,ax.y);ctx.lineTo(ax.x,ax.y+10*dpr);ctx.lineTo(ax.x+6*dpr,ax.y);ctx.strokeStyle='rgba(79,172,254,0.4)';ctx.lineWidth=1.5*dpr;ctx.stroke();
  ctx.beginPath();ctx.moveTo(ax.x,ax.y-6*dpr);ctx.lineTo(ax.x,ax.y+10*dpr);ctx.strokeStyle='rgba(79,172,254,0.3)';ctx.lineWidth=1*dpr;ctx.stroke();}
  // Drag (behind car)
  {const ax=cc(-0.04,0.45);ctx.beginPath();ctx.moveTo(ax.x,ax.y-5*dpr);ctx.lineTo(ax.x-10*dpr,ax.y);ctx.lineTo(ax.x,ax.y+5*dpr);ctx.strokeStyle='rgba(232,60,60,0.4)';ctx.lineWidth=1.5*dpr;ctx.stroke();
  ctx.beginPath();ctx.moveTo(ax.x+8*dpr,ax.y);ctx.lineTo(ax.x-10*dpr,ax.y);ctx.strokeStyle='rgba(232,60,60,0.3)';ctx.lineWidth=1*dpr;ctx.stroke();}
  // Grip (under car)
  {const ax=cc(0.50,0.74);ctx.beginPath();ctx.moveTo(ax.x-5*dpr,ax.y);ctx.lineTo(ax.x,ax.y-8*dpr);ctx.lineTo(ax.x+5*dpr,ax.y);ctx.strokeStyle='rgba(0,200,100,0.4)';ctx.lineWidth=1.2*dpr;ctx.stroke();}

  // IR sensor dot (front bumper — right)
  const irDet=S.lastData&&S.lastData.ir==='OBSTACLE DETECTED';
  const pulse=0.5+0.5*Math.sin(carT2*4.5);
  const irc=irDet?'#e8002d':'#00d67a';
  const irP=cc(1.01,0.56);
  ctx.beginPath();ctx.arc(irP.x,irP.y,4*dpr,0,Math.PI*2);
  ctx.fillStyle=irc;ctx.shadowColor=irc;ctx.shadowBlur=irDet?22+pulse*14:8;ctx.fill();ctx.shadowBlur=0;
  if(irDet){ctx.beginPath();ctx.arc(irP.x,irP.y,(8+pulse*8)*dpr,0,Math.PI*2);ctx.strokeStyle=`rgba(232,0,45,${0.55-pulse*0.28})`;ctx.lineWidth=1.2*dpr;ctx.stroke();}

  ctx.restore();
}

// ══════════════════════════════════════════════════════════
// RENDER LOOP
// ══════════════════════════════════════════════════════════
function frame(){
  drawCarModel();
  drawECG();
  requestAnimationFrame(frame);
}

window.addEventListener('load',()=>{
  sizeCar();
  airParticles.forEach(p=>{
    const el=document.getElementById('carCanvas');
    initAP(p,el.width||600,el.height||160);
  });

  document.getElementById('rawIn').value=
`------ DATA ------
IR: OBSTACLE DETECTED
Accel: 0.162, 0.078, 1.013
Temp (C): 25.49
Humidity (%): 54.42
BPM: 78
Gas: 142`;
  document.getElementById('injBtn').click();
  frame();
});

window.addEventListener('resize',()=>{
  if(S.activePanel==='car') sizeCar();
});
</script>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module">
import { MaptilerLayer } from 'https://esm.sh/@maptiler/leaflet-maptilersdk@4.1.1';

const MAP_API_KEY = 'EzMOvOnX3aoxjbVXKfOI';

// Default center — Monaco Circuit (F1)
const DEFAULT_LAT = 43.7347;
const DEFAULT_LON = 7.4205;

if (L.Icon.Default.prototype._getIconUrl) {
  delete L.Icon.Default.prototype._getIconUrl;
}
L.Icon.Default.mergeOptions({
  iconRetinaUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
  iconUrl:       'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
  shadowUrl:     'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
});

const leafletMap = L.map('mapCanvas', {
  center: [DEFAULT_LAT, DEFAULT_LON],
  zoom: 15,
  zoomControl: false,
  attributionControl: false,
});

new MaptilerLayer({ apiKey: MAP_API_KEY, style: 'streets-v4-dark' }).addTo(leafletMap);

// Pulsing GPS marker using a custom DivIcon
function makePulseIcon(color) {
  return L.divIcon({
    className: '',
    html: `<div style="position:relative;width:22px;height:22px;">
      <div style="position:absolute;inset:0;border-radius:50%;background:${color};opacity:0.25;animation:gps-ring 1.6s ease-out infinite;"></div>
      <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:10px;height:10px;border-radius:50%;background:${color};border:2px solid #fff;box-shadow:0 0 8px ${color};"></div>
    </div>`,
    iconSize: [22, 22],
    iconAnchor: [11, 11],
  });
}

const carMarker = L.marker([DEFAULT_LAT, DEFAULT_LON], {
  icon: makePulseIcon('#4facfe'),
}).addTo(leafletMap);

// Expose map globally for panel resize
window._leafletMap = leafletMap;

// Simulated movement around the default center (Monaco-ish circuit loop)
let t = 0;
function animateMarker() {
  t += 0.0008;
  const lat = DEFAULT_LAT + Math.sin(t * 0.6) * 0.0018 + Math.sin(t * 1.5) * 0.0006;
  const lon = DEFAULT_LON + Math.cos(t * 0.4) * 0.003  + Math.cos(t * 1.1) * 0.001;
  carMarker.setLatLng([lat, lon]);

  // Update marker color based on IR obstacle state
  const irDet = window.S && window.S.lastData && window.S.lastData.ir === 'OBSTACLE DETECTED';
  carMarker.setIcon(makePulseIcon(irDet ? '#e8002d' : '#4facfe'));

  const dist = leafletMap.distance(leafletMap.getCenter(), [lat, lon]);
  if (dist > 80) leafletMap.panTo([lat, lon], { animate: true, duration: 0.5 });

  requestAnimationFrame(animateMarker);
}
animateMarker();
</script>
<style>
@keyframes gps-ring {
  0%   { transform: scale(0.5); opacity: 0.7; }
  100% { transform: scale(2.5); opacity: 0; }
}
</style>
</body>
</html>
